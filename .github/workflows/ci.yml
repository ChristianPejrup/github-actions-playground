name: .NET Core CI

on:
  push:
    branches: 
      - master
      - feature/*
  pull_request:
    branches: 
      - master

env:
  CONFIGURATION: Release
  CODECOVERAGE_DIRECTORY: ./coverage-reports
  CODECOVERAGE_REPORT: coverage.opencover.xml

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x

    - name: Install dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore

    - name: Install Coverlet
      run: dotnet tool install --global coverlet.console
    
    - name: Test with coverage
      run: |
        $testDlls = Get-ChildItem -Path "tests/**/bin/**/*tests.dll" -Recurse
        foreach ($dll in $testDlls) {
            $trimmedPath = $dll.FullName -replace '\\bin\\.*', ''
            coverlet $dll.FullName --target "dotnet" --targetargs "test --configuration ${{ env.CONFIGURATION }} $trimmedPath --no-build" --format cobertura --output "${{ env.CODECOVERAGE_DIRECTORY }}/$(Split-Path $dll -Leaf).coverage.cobertura.xml"
        }
      shell: pwsh

    # - name: Install ReportGenerator
    #   run: dotnet tool install --global dotnet-reportgenerator-globaltool

    # - name: Generate report
    #   run: |
    #     $coverageReports = (Get-ChildItem -Path "${{ env.CODECOVERAGE_DIRECTORY }}" -Filter "*.coverage.opencover.xml" -Recurse | ForEach-Object { $_.FullName }) -join ";"
    #     reportgenerator "-reports:$coverageReports" "-targetdir:${{ env.CODECOVERAGE_DIRECTORY }}" "-reporttypes:Html;Cobertura"
    #   shell: pwsh
    - name: ReportGenerator
      uses: danielpalme/ReportGenerator-GitHub-Action@5.2.0
      with:
        reports: '**/*.coverage.cobertura.xml'
        targetdir: '${{ env.CODECOVERAGE_DIRECTORY }}'
        reporttypes: 'HtmlInline;Cobertura'

    - name: Publish report
      uses: actions/upload-artifact@v4
      with:
        name: code-coverage-report
        path: ${{ env.CODECOVERAGE_DIRECTORY }}